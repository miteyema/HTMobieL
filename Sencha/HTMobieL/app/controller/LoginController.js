/*
 * File: app/controller/LoginController.js
 *
 * This file was generated by Sencha Architect version 2.1.0.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Sencha Touch 2.0.x library, under independent license.
 * License of Sencha Architect does not include license for Sencha Touch 2.0.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('Expense.controller.LoginController', {
    extend: 'Ext.app.Controller',

    config: {
        refs: {
            login: 'loginpanel'
        },

        control: {
            "#login": {
                tap: 'onButtonTap'
            }	
        }
    },

    onButtonTap: function(button, e, options) {
        var fields= this.getLogin().getValues();  
        Ext.Ajax.request({
			url : 'http://localhost:8888/resources/userService/login', //TODO url
			method : 'POST',
			useDefaultXhrHeader: false, //http://stackoverflow.com/questions/10830334/ext-ajax-request-sending-options-request-cross-domain-when-jquery-ajax-sends-get
			params: {
                email: fields.email,
                password: fields.password
            },
			callback : function(options, success, response) {
				console.log("callback LOGIN");
				
				Expense.app.setToken(response.responseText);
				console.log(Expense.app.getToken());
				
				Ext.Viewport.setActiveItem(Ext.getCmp('viewport'));
				
				var employeeStore = Ext.getStore('employeestore');
				employeeStore.getProxy().setExtraParams({
					token: Expense.app.token
				});
				employeeStore.load({
				    callback: function(records, operation, success) {
						var employee = employeeStore.getAt(0);
						var infopanel = Ext.getCmp('infopanel'); //TODO niet met ids werken!
						infopanel.setRecord(employee); 
						var today = new Date();
						console.log(today.getUTCMonth());
						if(today.getUTCDate() < 14)
							infopanel.getComponent('infofield').getComponent('month').setValue((today.getUTCMonth()+1) % 13);
						else
							infopanel.getComponent('infofield').getComponent('month').setValue((today.getUTCMonth()+2) % 13);
						infopanel.getComponent('infofield').getComponent('year').setValue('7'); //TODO welk jaar invullen en waarop gebaseerd?
						
				    }
				});	
			}
		});

    }

});